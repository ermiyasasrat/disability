{{ 'component-sibling-products.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign limit = block.settings.sibling_products_limit
  assign layout = block.settings.sibling_products_layout
  assign block_title = block.settings.sibling_products_title
  assign column = block.settings.sibling_products_per_row
  assign selected_collection = block.settings.sibling_products_collection
  assign image_width = block.settings.sibling_product_image_width | default: 60
  assign image_height = block.settings.sibling_product_image_height | default: 60

  assign sibling_products = blank

  comment
    If a specific collection is selected, use that collection
    Otherwise, use products from the same collection(s) as the current product
    Exclude the current product from the results
  endcomment

  if selected_collection != blank
    assign all_products = selected_collection.products | where: 'available', true
    assign sibling_products = all_products
  elsif product.collections.size > 0
    assign first_collection = product.collections.first
    assign all_products = first_collection.products | where: 'available', true
    assign sibling_products = all_products
  endif

  assign products_to_display = 0
  if sibling_products.size > 0
    for prod in sibling_products
      if prod.id != product.id
        assign products_to_display = products_to_display | plus: 1
      endif
    endfor
    if products_to_display > limit
      assign products_to_display = limit
    endif
  endif
-%}

<style type="text/css" media="screen">
  .sibling-products-block {
      background-color: var(--sibling-bg);
      padding-top: var(--spacing-top);
      padding-bottom: var(--spacing-bottom);
      margin-top: 20px;
      border-radius: 8px;
      --sibling-image-width: {{ image_width }}px;
      --sibling-image-height: {{ image_height }}px;
  }

  .sibling-products-block .sibling-products-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
  }

  .sibling-products-column {
      display: flex;
      flex-direction: column;
      gap: 15px;
  }

  .sibling-products-column .product {
      border: 1px solid #e9e9e9;
      border-radius: 6px;
      overflow: hidden;
      transition: all 0.3s ease;
      background: #ffffff;
      display: flex;
      align-items: center;
      padding: 12px;
  }

  .sibling-products-column .product:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-1px);
      border-color: #d1d1d1;
  }

  .sibling-products-column .product .card-product {
      display: flex;
      align-items: center;
      width: 100%;
      gap: 25px;
  }

  .sibling-products-column .product .card-product__media {
      flex-shrink: 0;
      width: var(--sibling-image-width);
      height: var(--sibling-image-height);
  }

  .sibling-products-column .product .card-product__content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
  }

  .sibling-products-column .product .card-product__title {
      font-size: 13px;
      font-weight: 500;
      line-height: 1.3;
      margin: 0;
  }

  .sibling-products-column .product .card-product__price {
      font-size: 12px;
      font-weight: 600;
      color: #333;
  }

  .sibling-products-column .product .card-product__title a {
      color: #333;
      text-decoration: none;
  }

  .sibling-products-column .product .card-product__title a:hover {
      color: #007bff;
  }

  .sibling-products-grid {
      display: grid;
      gap: 15px;
      grid-template-columns: repeat(2, 1fr);
  }

  .sibling-products-grid.column-1 { grid-template-columns: 1fr; }
  .sibling-products-grid.column-2 { grid-template-columns: repeat(2, 1fr); }
  .sibling-products-grid.column-3 { grid-template-columns: repeat(3, 1fr); }
  .sibling-products-grid.column-4 { grid-template-columns: repeat(4, 1fr); }

  @media (max-width: 767px) {
      .sibling-products-grid {
          grid-template-columns: repeat(2, 1fr);
      }

      .sibling-products-column .product {
          padding: 10px;
      }

      .sibling-products-column .product .card-product {
          gap: 10px;
      }

      .sibling-products-column .product .card-product__media {
          width: calc(var(--sibling-image-width) * 0.85);
          height: calc(var(--sibling-image-height) * 0.85);
      }

      .sibling-products-column .product .card-product__title {
          font-size: 12px;
      }

      .sibling-products-column .product .card-product__price {
          font-size: 11px;
      }
  }

  .sibling-products-empty {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
  }
</style>

{%- if products_to_display > 0 -%}
  {%- if block_title != blank -%}
    <h3 class="sibling-products-title">{{ block_title | escape }}</h3>
  {%- endif -%}

  <div class="sibling-products-content">
    {%- if layout == 'column' -%}
      <div class="sibling-products-column">
        {%- assign displayed_count = 0 -%}
        {%- for sibling_product in sibling_products -%}
          {%- if sibling_product.id != product.id and displayed_count < limit -%}
            <div class="product">
              {% render 'sibling-product-card',
                product_card_product: sibling_product,
                media_size: 'square',
                portrait_aspect_ratio: '100',
                show_vendor: false,
                show_rating: false,
                show_quick_add: false,
                placeholder_index: forloop.index,
                image_width: image_width,
                image_height: image_height
              %}
            </div>
            {%- assign displayed_count = displayed_count | plus: 1 -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    {%- else -%}
      <div class="sibling-products-grid column-{{ column }}">
        {%- assign displayed_count = 0 -%}
        {%- for sibling_product in sibling_products -%}
          {%- if sibling_product.id != product.id and displayed_count < limit -%}
            <div class="product">
              {% render 'product-grid-layout',
                product_card_product: sibling_product,
                media_size: 'square',
                portrait_aspect_ratio: '100',
                serial: forloop.index,
                sectionId: 'sibling-block'
              %}
            </div>
            {%- assign displayed_count = displayed_count | plus: 1 -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    {%- endif -%}
  </div>
{%- elsif product.collections.size > 0 or selected_collection != blank -%}
  {%- if block_title != blank -%}
    <h3 class="sibling-products-title">{{ block_title | escape }}</h3>
  {%- endif -%}
  <div class="sibling-products-empty">
    <p>No other products available in this collection.</p>
  </div>
{%- endif -%}
